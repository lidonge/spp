# S++分布式数据库需求及参考设计

面向对象从宏观的角度来模拟业务活动，宏观世界对象种类数不胜数，各种关联关系错综复杂，所以这就造成了关系型数据库强大的关系运算能力。而在微观层面，物理世界中庞大的对象种类只剩下有限的几种基本粒子，所以S++从微观角度来模拟业务活动，宏观对象之间的关系就变得基本没有意义了，毕竟父子血缘关系对原子尺度的物质运动应该不会有太多影响。

从S++建模过程中可以发现，支撑模型只需要如下两种数据结构：

- 自然实体存储结构，比如Person，Store等。
- 各种流水信息，用来记录业务事件。

## 基本需求

### 自然实体

- 自然实体需要能够按照NativeID进行检索和存取

  的存取并没有需求一定要区分实体的类型，比如去访问一个Person数据的时候，其实Person这个数据类型并没有任何实际的帮助。应用只需要知道这是个自然实体，然后根据自然实体的NativeID就可以访问一个Person数据。

- 自然实体之间不存在任何关联，所以对自然实体的任何修改都不必考虑关联的影响。

- 自然实体不需要删除或“消亡”，不参与任何业务活动的自然实体其实就是消亡的实体。

- 如果有按自然实体的属性进行检索需求？那么就需要建立索引文件，而且需要随着属性的改变动态的修改索引。

- 自然实体保持全局单例，无论有多少个应用，自然实体只存在一个实例，所有的修改都必须基于单例进行修改。

### 流水信息

* 流水永远不会被修改
* 流水与实体之间不存在任何关联，流水只是实体活动的凭证和历史记录。
* 流水和流水之间通过流水号进行关联，相同流水号的流水记录的是同一个业务活动的不同部分内容。
* 最基本的检索方式是通过流水号进行检索，如果需要根据契约内容进行检索，就需要建立索引。
* 流水有按照领域进行分区的需求，业务领域是一群业务场景的集合，不同的领域之间可能会有数据隔离的需求。

## 核心参考设计

核心参考设计假设存在一个数据库管理程序，用于管理来自S++应用的数据存取和管理需求，这个管理程序被命名为SDBMS。核心参考设计不考虑多领域，多租户问题。

### 数据集中方案

数据集中方案中，数据不存在活跃的副本，任何数据包括实体和流水，都有且只有一份物理实体存在。数据集中方案规定了S++数据存储的基本功能要求，以及设计指标和应用架构要求。

#### 自然实体存储结构

自然实体按照数据块文件的方式存储，每一个数据块文件可以存储N（N <= 2^31）个自然实体，SDBMS中存储M（M <= 2^31）个数据块的NativeID索引文件，用于按照NativeID进行检索和访问自然实体。

**NativeID索引文件**存储的是NativeID索引记录，每一条记录是定长的，内容如下：

| 字段名         | 类型  | 长度（字节） | 描述                             |
| -------------- | ----- | ------------ | -------------------------------- |
| start_position | long  | 8            | 当前记录在数据块文件中的起始位置 |
| length         | short | 2            | 记录的长度（不超过65535）        |

NativeID是一个8字节的长整型，前面4个字节标识了实体存储的数据块，后面4个字节标识了实体在数据块中的具体位置。索引文件每条记录10个字节长，每个索引文件最多存储2^31个索引，最大占用20G字节的存储空间。

**数据块文件**结构如下：

| 字段名      | 类型   |   长度  （字节）    | 描述                                                         |
| :---------- | ------ | :-----------------: | ------------------------------------------------------------ |
| type        | int    |          4          | 系统为每个预定义的实体类分配一个编号，对不同的实体采用不同的存储格式和元数据，系统可以按照实体类型来找到相应的存储格式和元数据。 |
| content_len | short  |          2          | 当前实体所占用的字节数（<=65535 - 4 - 2 - 8 )                |
| content     | byte[] | <=65535 - 4 - 2 - 8 | 按字节存储的实体内容                                         |
| ext_pos     | long   |          8          | 指向扩展内容的指针                                           |

#### 自然实体的检索

基于上述的存储结构，自然实体可以通过间接寻址快速的被定位，首先通过NativeID的前4个字节定位数据块文件，然后根据NativeID的后4个字节定位数据块索引文件中的记录位置，从索引文件中取得记录的起始地址start_position，然后从数据块文件中start_position位置开始读取length个字节的实体数据。

可以认为自然实体根据NativeID进行检索的时间复杂度为O(1)。

#### 流水信息的存储结构

流水的存储结构比自然实体还要简单，因为流水一旦产生就是只读的无需修改，所以数据块文件中原本用于扩展的ext_pos字段就不需要了，并且流水号SerialNo取代了自然实体的NativeID。

### 分布式数据方案

狭义的数据分布式指的数据是否存在多份相同的拷贝，这里的分布式流水讨论的就是狭义的数据分布式。SDBMS天然就支持数据分布式，因为在SDBMS中数据是分块存储的，可以设置镜像数据块来解决数据分布式的问题。

比如，可以将SDBMS全局设置成1:1的镜像模式，那么意味着任何一条记录被插入一个数据块或进行修改，都会导致这个数据块的镜像块同时被操作。

**注意**：SDBMS的镜像数据块依然遵从分布式数据的CAP定理，也就是说需要告诉SDBMS如何平衡一致性和可用性。